from fastapi.testclient import TestClient
from pathlib import Path
from app import app

client = TestClient(app)

# Define the path to the files directory
FILES_DIR = Path("files")

def test_download_existing_file():
    # Use a valid file name that exists in the files directory
    file_name = "script1.py"
    response = client.get(f"/files/{file_name}")

    # Assertions
    assert response.status_code == 200
    assert response.headers["content-type"] == "application/octet-stream"
    assert "content-disposition" in response.headers
    assert response.headers["content-disposition"] == f'attachment; filename="{file_name}"'
    assert response.content == (FILES_DIR / file_name).read_bytes()


def test_download_nonexistent_file():
    # Use an invalid file name that does not exist
    file_name = "nonexistent.py"
    response = client.get(f"/files/{file_name}")

    # Assertions
    assert response.status_code == 404
    assert response.json() == {"detail": "File not found"}


def test_download_directory_traversal_attack():
    # Attempt directory traversal with a path like "../../etc/passwd"
    file_name = "../../etc/passwd"
    response = client.get(f"/files/{file_name}")

    # Assertions
    assert response.status_code == 404
    assert response.json() == {"detail": "File not found"}