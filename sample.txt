import React, { useState, useEffect } from "react";
import {
  Container, TextField, Button, MenuItem, Select, FormControl, InputLabel,
  Typography, Box, Paper, Alert, Checkbox
} from "@mui/material";
import Grid2 from "@mui/material/Unstable_Grid2";

const App = () => {
  const [alertThreshold, setAlertThreshold] = useState("10");
  const [nRecords, setNRecords] = useState("20");
  const [incidents, setIncidents] = useState([]);
  const [selectedIncident, setSelectedIncident] = useState("");
  const [incidentDetails, setIncidentDetails] = useState([]);
  const [summarizedDetails, setSummarizedDetails] = useState(null);
  const [isDropdownPopulated, setIsDropdownPopulated] = useState(false);

  const fetchIncidents = async () => {
    try {
      const response = await api.get("/ais/v1/incidents", {
        params: { alert_threshold: alertThreshold, n_records: nRecords }
      });
      const fetchedIncidents = Array.isArray(response.data) ? response.data : [];
      setIncidents(fetchedIncidents);

      // Auto-select the first incident if available
      if (fetchedIncidents.length > 0) {
        const firstIncidentId = fetchedIncidents[0].id.toString();
        setSelectedIncident(firstIncidentId);
        handleIncidentSelect(firstIncidentId); // Fetch details for the first incident
      }

      setIsDropdownPopulated(true);
    } catch (error) {
      console.error("Error fetching incidents:", error);
      setIncidents([]);
      setIsDropdownPopulated(false);
    }
  };

  const handleIncidentSelect = async (incidentId) => {
    setSelectedIncident(incidentId);
    try {
      const response = await api.get(`/ais/v1/incidents/${incidentId}/description`);
      setIncidentDetails(response.data);
    } catch (error) {
      console.error("Error fetching incident details:", error);
      setIncidentDetails([]);
    }
  };

  const summarizeIncident = async () => {
    if (!selectedIncident) return;
    try {
      const response = await api.get(`/ais/v1/incidents/${selectedIncident}/summarize`);
      setSummarizedDetails(response.data);
    } catch (error) {
      console.error("Error summarizing incident:", error);
      setSummarizedDetails(null);
    }
  };

  return (
    <Container maxWidth={false} sx={{ mt: 5, height: "100vh", width: "100%", p: 0 }}>
      <Typography variant="h4" textAlign="center" fontWeight="bold" color="primary" gutterBottom>
        Advanced Incident Summarization
      </Typography>

      <Box sx={{ display: "flex", height: "80vh", mt: 2, gap: 2 }}>
        <Paper elevation={3} sx={{ p: 3, flex: 1, display: "flex", flexDirection: "column", overflowY: "auto", width: "48%" }}>
          <TextField
            label="alert_threshold"
            fullWidth
            variant="outlined"
            value={alertThreshold}
            onChange={(e) => setAlertThreshold(e.target.value)}
            sx={{ backgroundColor: "white", borderRadius: 1, mb: 2, "& .MuiInputBase-root": { height: 40 } }}
          />
          <TextField
            label="n_records"
            fullWidth
            variant="outlined"
            value={nRecords}
            onChange={(e) => setNRecords(e.target.value)}
            sx={{ backgroundColor: "white", borderRadius: 1, mb: 2, "& .MuiInputBase-root": { height: 40 } }}
          />
          <Button
            variant="contained"
            color="secondary"
            onClick={fetchIncidents}
            sx={{ fontWeight: "bold", width: "100%", height: 40, mb: 2 }}
          >
            Get Incidents
          </Button>
          <FormControl fullWidth sx={{ mb: 2 }}>
            <InputLabel shrink sx={{ backgroundColor: "white", px: 1 }}>
              DD Incidents
            </InputLabel>
            <Select
              value={selectedIncident || ""}
              onChange={(e) => handleIncidentSelect(e.target.value)}
              sx={{ backgroundColor: "white", borderRadius: 1, "& .MuiInputBase-root": { height: 40 } }}
              MenuProps={{ PaperProps: { sx: { maxHeight: 200, marginTop: 1 } } }}
            >
              {isDropdownPopulated && (
                <MenuItem disabled sx={{ fontStyle: "italic" }}>
                  Dropdown is populated. Please select an incident.
                </MenuItem>
              )}
              {Array.isArray(incidents) && incidents.map((incident) => (
                <MenuItem key={incident.id} value={incident.id ? incident.id.toString() : ""}>
                  {`Incident ${incident.id}`}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
          <Typography variant="h6" fontWeight="bold" color="primary" gutterBottom>
            Incident Details
          </Typography>
          <Box sx={{ flex: 1, overflowY: "auto", pr: 2 }}>
            {incidentDetails.map((alert) => (
              <Box
                key={alert.id}
                onClick={() => setSelectedIncident(alert.id.toString())}
                sx={{
                  backgroundColor: selectedIncident === alert.id.toString() ? "#e3f2fd" : "white",
                  borderRadius: 1,
                  p: 1.5,
                  mb: 1,
                  boxShadow: 1,
                  cursor: "pointer",
                  display: "flex",
                  alignItems: "center",
                  gap: 1,
                  "&:hover": { backgroundColor: "#e3f2fd" },
                  border: selectedIncident === alert.id.toString() ? "2px solid #1976d2" : "1px solid #e0e0e0",
                }}
              >
                <Checkbox
                  checked={selectedIncident === alert.id.toString()}
                  sx={{ p: 0, color: "#1976d2" }}
                />
                <Typography variant="subtitle1" fontWeight="bold" color="text.primary">
                  Incident ID: {alert.id}
                </Typography>
              </Box>
            ))}
          </Box>
        </Paper>

        <Paper elevation={3} sx={{ p: 3, flex: 1, display: "flex", flexDirection: "column", overflowY: "auto", width: "48%" }}>
          <Button
            variant="contained"
            color="success"
            onClick={summarizeIncident}
            sx={{ fontWeight: "bold", width: "100%", height: 40, mb: 2 }}
          >
            Summarize
          </Button>
          <Typography variant="h6" fontWeight="bold" color="primary" gutterBottom>
            Summarized Details
          </Typography>
          <Box sx={{ flex: 1, overflowY: "auto", pr: 2 }}>
            {summarizedDetails ? (
              <Box sx={{ backgroundColor: "white", borderRadius: 1, p: 2, mb: 2, boxShadow: 1 }}>
                <Typography variant="subtitle1" fontWeight="bold" color="text.primary">
                  Summary: {summarizedDetails.summary}
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                  <strong>Key Points:</strong> {summarizedDetails.keyPoints}
                </Typography>
              </Box>
            ) : (
              <Typography sx={{ mt: 1, fontStyle: "italic" }}>No summarized details available</Typography>
            )}
          </Box>
        </Paper>
      </Box>
    </Container>
  );
};

export default App;